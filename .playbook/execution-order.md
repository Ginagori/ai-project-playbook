# Execution Order — Playbook Evolution

> **Generated by AI Project Playbook — applying itself to itself**
> **Date:** 2026-02-19
> **Features:** 6
> **Estimated files modified:** 4 (orchestrator.py, prp_builder.py, project.py) + 2 new (template_loader.py, memory_bridge.py)

---

## Dependency Graph

```
[01] Template Loader ──────────────────┐
     (no deps)                         ├──→ [04] Enriched Planning
                                       │         (deps: 01, 02, 03)
[02] Memory Bridge ─────────┬──────────┤
     (no deps)              │          ├──→ [05] PRP Template Compliance
                            │          │         (deps: 01, 02)
                            ├──→ [03] Smart Discovery
                            │         (deps: 02)   ├──→ [06] Experience Roadmap
                            │                       │         (deps: 02)
                            └───────────────────────┘
```

## Execution Waves

### Wave 1 — Foundations (no dependencies, parallelizable)

| # | PRP | File | Action | Lines Est. |
|---|-----|------|--------|------------|
| 01 | Template Loader | `agent/template_loader.py` | **CREATE** | ~120 |
| 02 | Memory Bridge | `agent/memory_bridge.py` | **CREATE** | ~150 |

These two are independent. Can be implemented in any order or simultaneously.

---

### Wave 2 — Context Enrichment (depends on Wave 1)

| # | PRP | File | Action | Lines Est. |
|---|-----|------|--------|------------|
| 03 | Smart Discovery | `agent/orchestrator.py` + `agent/models/project.py` | **MODIFY** | ~80 modified |

Depends on: PRP 02 (MemoryBridge) for querying similar projects during discovery.

---

### Wave 3 — Artifact Quality (depends on Waves 1 + 2)

| # | PRP | File | Action | Lines Est. |
|---|-----|------|--------|------------|
| 04 | Enriched Planning | `agent/orchestrator.py` | **MODIFY** | ~100 modified |
| 05 | PRP Template Compliance | `agent/prp_builder.py` | **MODIFY** | ~80 modified |
| 06 | Experience Roadmap | `agent/orchestrator.py` | **MODIFY** | ~80 modified |

PRPs 04 and 06 both modify `orchestrator.py` — implement 04 first (planning_node), then 06 (roadmap_node) since they modify different functions.

PRP 05 modifies `prp_builder.py` — independent of 04/06, can be done in parallel.

---

## Recommended Implementation Sequence

```
1. PRP 01 — Template Loader          ← CREATE new file, no risk
2. PRP 02 — Memory Bridge            ← CREATE new file, no risk
3. PRP 03 — Smart Discovery          ← MODIFY orchestrator.py (discovery_node)
4. PRP 04 — Enriched Planning        ← MODIFY orchestrator.py (planning_node)
5. PRP 06 — Experience Roadmap       ← MODIFY orchestrator.py (roadmap_node)
6. PRP 05 — PRP Template Compliance  ← MODIFY prp_builder.py
```

> Note: PRP 06 before PRP 05 because 06 modifies the same file as 03/04 (orchestrator.py) — batching changes to the same file reduces merge conflicts. PRP 05 touches a different file (prp_builder.py) so it goes last.

---

## Validation Strategy

After **each PRP**, run:
```bash
# Syntax
ruff check agent/ --fix && ruff format agent/

# Types
mypy agent/orchestrator.py agent/prp_builder.py --ignore-missing-imports

# Import check
.venv/Scripts/python.exe -c "from mcp_server.playbook_mcp import mcp; print('MCP OK')"
```

After **all 6 PRPs**, run full integration:
```bash
.venv/Scripts/python.exe -c "
import asyncio
async def test():
    from mcp_server.playbook_mcp import start_project
    result = await start_project('Build a workplace safety SaaS for Colombia', 'supervised')
    print(result[:1000])
asyncio.run(test())
"
```

---

## Files Summary

| File | PRPs that touch it | Action |
|------|--------------------|--------|
| `agent/template_loader.py` | 01 | CREATE |
| `agent/memory_bridge.py` | 02 | CREATE |
| `agent/models/project.py` | 03 | MODIFY (add `discovery_context`) |
| `agent/orchestrator.py` | 03, 04, 06 | MODIFY (3 different functions) |
| `agent/prp_builder.py` | 05 | MODIFY (`build_feature_prp`) |

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| MemoryBridge Supabase connection fails | Low — all queries wrapped in try/except | Fallback to local JSON + empty results |
| Template parsing breaks on nested code fences | Medium — PRPs could have malformed sections | TemplateLoader handles fences explicitly (PRP 01) |
| Too many features in roadmap | Low — capped at 10 | Hard cap in roadmap_node |
| Orchestrator regression | High — core state machine | Each PRP modifies a different function; validate imports after each |
| CLAUDE.md too long after enrichment | Medium — bloats context window | PRP 04 cap at 200 lines |
